import sqlite3
import threading

import iw

"""
IEEE80211(framectl=32768, ssid=IE(len=8, info='TPLINK-M', data='TPLINK-M'), ie_42=IE(id=42, len=1, info='\x04', data='\x04'), 
ie_127=IE(id=127, len=1, info='\x01', data='\x01'), ies=None, fcs_present=False, ie_48=IE(id=48, len=20, 
info='\x01\x00\x00\x0f\xac\x02\x01\x00\x00\x0f\xac\x04\x01\x00\x00\x0f\xac\x02\x00\x00', data='\x01\x00\x00\x0f\xac\x02\x01\x00\x00\x0f
\xac\x04\x01\x00\x00\x0f\xac\x02\x00\x00'), rate=IE(id=1, len=8, info='\x82\x84\x8b\x96\x0c\x12\x18$', data='\x82\x84\x8b\x96\x0c\x12\x18$'),
capability=<dpkt.ieee80211.Capability object at 0x7f5e7d8b2110>, tim=TIM(id=5, len=4, period=1, bitmap='\x00', data='\x00\x01\x00\x00'), 
beacon=Beacon(timestamp=9088732539106885632, interval=25600, capability=4356, data="\x00\x08TPLINK-M\x01\x08\x82\x84\x8b\x96\x0c\x12\x18$\x03
\x01\x01\x05\x04\x00\x01\x00\x00*\x01\x042\x040H`l-\x1an\x18\x1f\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00=\x16\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00J\x0e\x14\x00\n\x00\xb4\x00\xc8
\x00\x14\x00\x05\x00\x19\x00\x7f\x01\x01\xdd\x16\x00P\xf2\x01\x01\x00\x00P\xf2\x02\x01\x00\x00P\xf2\x04\x01\x00\x00P\xf2\x020\x14\x01\x00\x00
\x0f\xac\x02\x01\x00\x00\x0f\xac\x04\x01\x00\x00\x0f\xac\x02\x00\x00\xdd\x18\x00P\xf2\x02\x01\x01\x00\x00\x03\xa4\x00\x00'\xa4\x00\x00BC^\x00b2/
\x00\xdd\x1e\x00\x90L3n\x18\x1f\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x1a\x00\x90L4\x01
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x06\x00\xe0L\x02\x01`\xdd\x18\x00P\xf2\x04\x10J\x00\x01
\x10\x10D\x00\x01\x02\x10I\x00\x06\x007*\x00\x01 \x97\xd4\xa5\xaa"), ht_info=IE(id=61, len=22, info='\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00', data='\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'),
ie_74=IE(id=74, len=14, info='\x14\x00\n\x00\xb4\x00\xc8\x00\x14\x00\x05\x00\x19\x00', data='\x14\x00\n\x00\xb4\x00\xc8\x00\x14\x00\x05\x00\x19\x00'),
mgmt=MGMT_Frame(dst='\xff\xff\xff\xff\xff\xff', src='\xc4\x12\xf5F\x7f\x9b', bssid='\xc4\x12\xf5F\x7f\x9b', frag_seq=45245, data="~!\xaa\x17\x14\x00
\x00\x00d\x00\x11\x04\x00\x08TPLINK-M\x01\x08\x82\x84\x8b\x96\x0c\x12\x18$\x03\x01\x01\x05\x04\x00\x01\x00\x00*\x01\x042\x040H`l-\x1an\x18\x1f\xff
\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00=\x16\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00\x00\x00J\x0e\x14\x00\n\x00\xb4\x00\xc8\x00\x14\x00\x05\x00\x19\x00\x7f\x01\x01\xdd\x16\x00P\xf2\x01\x01\x00\x00P\xf2
\x02\x01\x00\x00P\xf2\x04\x01\x00\x00P\xf2\x020\x14\x01\x00\x00\x0f\xac\x02\x01\x00\x00\x0f\xac\x04\x01\x00\x00\x0f\xac\x02\x00\x00\xdd\x18\x00P
\xf2\x02\x01\x01\x00\x00\x03\xa4\x00\x00'\xa4\x00\x00BC^\x00b2/\x00\xdd\x1e\x00\x90L3n\x18\x1f\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x1a\x00\x90L4\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\xdd\x06\x00\xe0L\x02\x01`\xdd\x18\x00P\xf2\x04\x10J\x00\x01\x10\x10D\x00\x01\x02\x10I\x00\x06\x007*\x00\x01 \x97\xd4\xa5\xaa"),
ie_221=IE(id=221, len=24, info='\x00P\xf2\x04\x10J\x00\x01\x10\x10D\x00\x01\x02\x10I\x00\x06\x007*\x00\x01 ', data='\x00P\xf2\x04\x10J\x00
\x01\x10\x10D\x00\x01\x02\x10I\x00\x06\x007*\x00\x01 '), ht_capa=IE(id=45, len=26, info='n\x18\x1f\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00', data='n\x18\x1f\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00'), ds=DS(id=3, len=1, ch=1, data='\x01'), esr=IE(id=50, len=4, info='0H`l', data='0H`l'), data="\x00\x08TPLINK-M
\x01\x08\x82\x84\x8b\x96\x0c\x12\x18$\x03\x01\x01\x05\x04\x00\x01\x00\x00*\x01\x042\x040H`l-\x1an\x18\x1f\xff\xff\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00=\x16\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00J\x0e\x14\x00\n\x00\xb4\x00\xc8\x00\x14\x00\x05\x00\x19\x00\x7f\x01\x01\xdd\x16\x00P\xf2\x01\x01\x00
\x00P\xf2\x02\x01\x00\x00P\xf2\x04\x01\x00\x00P\xf2\x020\x14\x01\x00\x00\x0f\xac\x02\x01\x00\x00\x0f\xac\x04\x01\x00\x00\x0f\xac
\x02\x00\x00\xdd\x18\x00P\xf2\x02\x01\x01\x00\x00\x03\xa4\x00\x00'\xa4\x00\x00BC^\x00b2/\x00\xdd\x1e\x00\x90L3n\x18\x1f\xff\xff
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x1a\x00\x90L4\x01\x00\x00\x00\x00\x00
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x06\x00\xe0L\x02\x01`\xdd\x18\x00P\xf2\x04\x10J\x00\x01\x10
\x10D\x00\x01\x02\x10I\x00\x06\x007*\x00\x01 \x97\xd4\xa5\xaa")
"""

"""
devices
name

authorized
name | mac
"""

authorized_aps = []
threads = []

def netifthread(netif, authorized):
	print("[netif %s] thread start" % netif)
	iwif = iw.IW(netif, authorized)
	timer = threading.Timer(0.250, netif_switchch, args=[iwif])
	print("[netif %s] entering loop" % netif)
	timer.start()
	iwif.loop()

def netif_switchch(*args):
	iwobj = args[0]
	newch = (iwobj.channel + 1) % 12
	if newch == 0:
		newch = 1
	if not iwobj.set_channel(newch):
		iwobj.set_channel(1)
	if iwobj.quit:
		return
	threading.Timer(0.5, netif_switchch, args=args).start()

dbconn = sqlite3.connect('config.db')

c = dbconn.cursor()

c.execute("CREATE TABLE IF NOT EXISTS devices(name varchar)")
c.execute("CREATE TABLE IF NOT EXISTS authorized(name varchar, mac varchar)")

for row in c.execute("SELECT name,mac FROM authorized"):
	authorized_aps.append((row[0], row[1]))

for row in c.execute("SELECT name FROM devices"):
	t = threading.Thread(target=netifthread, args=(row[0], authorized_aps))
	threads.append(t)

	t.start()

if len(threads) == 0:
	print("No devices defined")